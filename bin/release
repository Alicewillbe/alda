#!/usr/bin/env bash

set -e

version="$(cat "$(dirname "$0")/../VERSION")"

echo "--- Release version: $version ---"
echo

version_changelog="$($(dirname "$0")/version-changelog "$version")"

echo "========================================"
echo "$version_changelog"
echo "========================================"
echo
read -p "Is this changelog correct? [yN] "

if [[ "$REPLY" != "y" ]]; then
  echo "Aborting."
  exit 1
fi

# Pushing a tag whose name starts with "release-" causes CircleCI to do a build
# and upload the artifacts (via `bin/upload-release`).
release_tag="release-$version"
git tag -a "$release_tag" -m "$release_tag"
git push --tags

# TODO:
#
# * Post to Alda slack #general about the new release.
# ** To get the timing right, it would be better to configure CircleCI to post
# to Slack once a release build succeeds.

