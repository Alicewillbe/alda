#!/usr/bin/env bash

cd "$(dirname $0)/../"

mkdir -p target

# Keep the target folder from getting too big by deleting any builds older than
# 7 days.
find target/ -type d -mtime +7 -exec rm -vrf {} \;

build_sha="$(../bin/current-content-sha player)"
build_dir="target/$build_sha"

if [[ -d "$build_dir" ]]; then
  echo "Existing build: $PWD/$build_dir"
  exit 0
fi

./gradlew build
echo

mkdir -p "$build_dir/windows"
mkdir -p "$build_dir/non-windows"

non_windows_build="$build_dir/non-windows/alda-player"

echo "Building $non_windows_build..."

jvm_opts="-XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Xmx1024m -Xms256m"

cat \
  <(echo -e "#!/bin/sh\n\nexec java $jvm_opts -jar \$0 \"\$@\"\n\n\n") \
  "build/libs/alda-player-fat.jar" \
  > "$non_windows_build"

chmod +x "$non_windows_build"

# TODO:
# * Create the Windows build using launch4j.
# * Artifacts should go in target/$build_sha/

